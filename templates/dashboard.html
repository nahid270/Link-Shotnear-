<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>My Dashboard</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark"><div class="container">
        <a class="navbar-brand" href="/">üîó My Dashboard</a>
        <div>
            <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá -->
            <div id="admin-link-placeholder" class="d-inline-block"></div>
            <span class="navbar-text me-3" id="welcome-user"></span>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>
    </div></nav>
    <div class="container mt-4">
        <div class="card mb-4"><div class="card-body">
            <h4 class="card-title">Shorten a new link</h4>
            <form id="shorten-form" class="d-flex">
                <input type="url" id="original-url" class="form-control me-2" placeholder="https://example.com/very/long/url" required>
                <button type="submit" class="btn btn-primary">Shorten</button>
            </form>
            <div id="result" class="mt-3"></div>
        </div></div>
        <h3>My Links</h3>
        <div class="table-responsive"><table class="table table-striped table-hover">
            <thead><tr><th>Original URL</th><th>Short URL</th><th>Clicks</th></tr></thead>
            <tbody id="links-table-body"></tbody>
        </table></div>
    </div>
    <script>
        const token = localStorage.getItem('jwt_token');
        if (!token) { window.location.href = '/login-page'; }
        
        document.getElementById('welcome-user').innerText = `Welcome, ${localStorage.getItem('username')}!`;
        
        function logout() { 
            localStorage.clear(); // ‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá
            window.location.href = '/'; 
        }

        // --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°: ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ---
        const isAdmin = localStorage.getItem('is_admin');
        if (isAdmin === 'true') {
            document.getElementById('admin-link-placeholder').innerHTML = 
                `<a href="/admin-panel" class="btn btn-warning me-2">Admin Panel</a>`;
        }
        // ------------------------------------------

        async function fetchLinks() {
            const response = await fetch('/user/links', { headers: { 'Authorization': `Bearer ${token}` } });
            const links = await response.json();
            const tableBody = document.getElementById('links-table-body');
            tableBody.innerHTML = '';
            links.forEach(link => {
                const shortUrl = `${window.location.origin}/${link.short_id}`;
                tableBody.innerHTML += `
                    <tr>
                        <td class="text-truncate" style="max-width: 300px;"><a href="${link.original_url}" target="_blank">${link.original_url}</a></td>
                        <td><a href="${shortUrl}" target="_blank">${shortUrl}</a></td>
                        <td>${link.clicks}</td>
                    </tr>`;
            });
        }
        
        document.getElementById('shorten-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const url = document.getElementById('original-url').value;
            const resultDiv = document.getElementById('result');
            const response = await fetch('/shorten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ url })
            });
            const data = await response.json();
            if (response.ok) {
                resultDiv.innerHTML = `<div class="alert alert-success">Success! Short URL: <a href="${data.short_url}" target="_blank">${data.short_url}</a></div>`;
                fetchLinks(); this.reset();
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            }
        });
        
        fetchLinks();
    </script>
</body>
</html>
